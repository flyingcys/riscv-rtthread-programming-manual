<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5、线程切换 &mdash; RISC-V RT-Thread 编程指南 0.0.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            RISC-V RT-Thread 编程指南
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="1.html">RISC-V 概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.html">启动</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RISC-V RT-Thread 编程指南</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">5、线程切换</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/zh_CN/45.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>5、线程切换<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>RT-Thread 线程切换可以使用中断中实现上下文切换或者在线程上下文中切换。</p>
<ol class="simple">
<li><p>中断中实现上下文中切换是通过触发中断，在中断处理函数中保护现场、恢复现场切换至新线程等工作。ARM Core-M 系列、FreeRTOS 适配的 RISC-V 通常都采用这种方式，Cortex-M 架构触发 PendSV 中断，RISC-V 架构触发 software interrupt 中断，在中断处理函数中实现上下文切换。</p></li>
<li><p>线程中实现上下文切换是在线程中直接实现保护线程、恢复线程切换至新线程等工作。目前 RT-Thread 适配的 RISC-V 架构通常采用这种方式。</p></li>
</ol>
<p>RT-Thread 为什么在适配 RISC-V 架构在线程中实现上下文切换，而在 ARM Cortex-M 架构上使用在中断中实现上下文切换呢？</p>
<p>ARM Cortex-M 实现了自动硬件自动压栈和出栈一些寄存器，而 RISC-V 标准中并没有要求，RISC-V 架构在需要通过软件方式保存、恢复寄存器,通过中断实现上下文切换并没有带来性能提升。很多 IP 设计厂家会通过扩展方式实现了这部分功能，在保证通用性的前提下，RT-Thread 在 RISC-V 架构上通常采用在线程中实现上下文切换。</p>
<p>线程调度主要涉及到线程切出和切入，相对应的是保护现场和恢复现场。</p>
<ol class="simple">
<li><p>保护现场：
保护现场即保存源线程的当前寄存器状态至线程栈 sp 变量中，用于后续再次需要运行该线程后恢复现场。</p></li>
<li><p>恢复现场：
将目标线程栈中的 sp 变量中保存的状态，恢复到当前寄存器中，并切换至目标线程。</p></li>
</ol>
<section id="id2">
<h2>5.1、相关寄存器<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<section id="id3">
<h3>通用寄存器<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h3>
<p>RISC-V 包含 32 个通用寄存器</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>寄存器</th>
<th>ABI 名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>x0</td>
<td>zero</td>
<td>零值</td>
</tr>
<tr>
<td>x1</td>
<td>ra</td>
<td>返回地址</td>
</tr>
<tr>
<td>x2</td>
<td>sp</td>
<td>堆栈指针</td>
</tr>
<tr>
<td>x3</td>
<td>gp</td>
<td>全局指针</td>
</tr>
<tr>
<td>x4</td>
<td>tp</td>
<td>线程指针</td>
</tr>
<tr>
<td>x5</td>
<td>t0</td>
<td>临时/备用链接寄存器</td>
</tr>
<tr>
<td>x6-7</td>
<td>t1-2</td>
<td>临时寄存器</td>
</tr>
<tr>
<td>x8</td>
<td>s0/fp</td>
<td>保留寄存器/帧指针</td>
</tr>
<tr>
<td>x9</td>
<td>s1</td>
<td>保留寄存器</td>
</tr>
<tr>
<td>x10-11</td>
<td>a0-a1</td>
<td>函数参数/返回值</td>
</tr>
<tr>
<td>x12-17</td>
<td>a2-a7</td>
<td>函数参数</td>
</tr>
<tr>
<td>x18-27</td>
<td>s2-s11</td>
<td>保留寄存器</td>
</tr>
<tr>
<td>x28-31</td>
<td>t3-t6</td>
<td>临时寄存器</td>
</tr>
</tbody>
</table></section>
<section id="ra">
<h3>RA<a class="headerlink" href="#ra" title="此标题的永久链接"></a></h3>
<p>[todo]</p>
</section>
<section id="mepc-machine-exception-program-counter">
<h3>MEPC（Machine Exception Program Counter）<a class="headerlink" href="#mepc-machine-exception-program-counter" title="此标题的永久链接"></a></h3>
<p>机器模式异常程序计数器（MEPC）用于存储程序从异常服务程序退出时要返回的程序计数器值（即 PC 值）。 E907 支持 16 位宽指令， PC 值以半字对齐，因此 MEPC 的最低位为常零，剩余高 31 位为写有效区
域。</p>
</section>
<section id="mstatus-machine-status-register">
<h3>MSTATUS（Machine Status Register）<a class="headerlink" href="#mstatus-machine-status-register" title="此标题的永久链接"></a></h3>
<p>RISC-V 中开关中断涉及到的 CSR 为 MSTATUS 寄存器。</p>
<section id="rv32">
<h4>RV32<a class="headerlink" href="#rv32" title="此标题的永久链接"></a></h4>
<p>MSTATUS 寄存器为机器模式处理器状态寄存器，该寄存器存储了处理器在机器模式下的状态和控制信息，包括全局中断有效位、异常保留中断有效位、异常保留特权模式位等。</p>
<p><img alt="MSTATUS" src="img/risc-v/risc-v/interrupt/MSTATUS.png" /></p>
<ol class="simple">
<li><p>MIE：机器模式全局中断使能位（bit3）</p></li>
</ol>
<ul class="simple">
<li><p>当 MIE 为 0 时，中断无效；</p></li>
<li><p>当 MIE 为 1 时，中断有效。
该位复位值为零，也在处理器响应异常时被清零；在处理器退出异常时被置为 MPIE 的值。</p></li>
</ul>
<ol class="simple">
<li><p>MPIE：机器模式保留中断使能位（bit7）
该位用于保存处理器进入异常服务程序前 MIE 位的值。
该位复位值为零，在处理器退出异常服务程序时被置 1。</p></li>
<li><p>MPP：机器模式保留特权状态位（bit12~bit11）
该位用于保存处理器进入异常服务程序前的特权状态。</p></li>
</ol>
<ul class="simple">
<li><p>当 MPP 为 2’ b00 时，表示处理器进入异常服务程序前处于用户模式；</p></li>
<li><p>当 MPP 为 2’ b11 时，表示处理器进入异常服务程序前处于机器模式；
该域复位值为 2’ b11。</p></li>
</ul>
<ol class="simple">
<li><p>FS-浮点寄存器状态位：
该域仅在配置硬件浮点时存在，用于指示浮点控制寄存器以及浮点通用寄存器的状态。
2’ b00：无法访问浮点控制寄存器和浮点通用寄存器，访问这类寄存器会触发非法指令异常；
2’ b01：浮点控制寄存器和浮点通用寄存器处于初始化状态；
2’ b10：浮点控制寄存器和浮点通用寄存器是干净的；
2’ b11：部分浮点控制寄存器或者浮点通用寄存器被写脏过；
在系统初始化时可将该域设置为 2’ b01 或者 2’ b10，硬件在程序运行中会维护 FS 域。在异常或中断服务程序入口如果判断 FS 非 2’ b11 的话，表明响应中断前没有将浮点相关寄存器现场写脏，因此异常或者中断服务程序的入口也无需对这些现场进行保存。
该域复位值为 2’ b00。</p></li>
<li><p>XS-用户模式浮点扩展状态位：
该域仅在配置硬件浮点时有意义， E907 将其硬件绑为 0。</p></li>
<li><p>MPRV：存储特权位（bit17）</p></li>
</ol>
<ul class="simple">
<li><p>当 MPRV 为 0 时，访存地址的转换和保护判断没有特殊要求；</p></li>
<li><p>当 MPRV 为 1 时，加载和存储指令（load/store）要根据 MPP 位中存储的特权模式信息进行地址转换和保护判断。取指的地址转换和保护判断不受该位影响。
该位复位值为零。
在处理器 CLIC 模式下， MPP 位和 MPIE 位可以通过 MCAUSE 寄存器访问得到。</p></li>
</ul>
</section>
<section id="rv64">
<h4>RV64<a class="headerlink" href="#rv64" title="此标题的永久链接"></a></h4>
</section>
</section>
<section id="mscratch">
<h3>MSCRATCH<a class="headerlink" href="#mscratch" title="此标题的永久链接"></a></h3>
<p>机器模式异常临时数据备份寄存器（MSCRATCH）用于处理器在异常服务程序中备份临时数据。一般用来存储机器模式本地上下文空间的入口指针值。</p>
</section>
</section>
<section id="id4">
<h2>5.2、相关数据结构与宏<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<section id="id5">
<h3>硬件栈数据结构<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>RT-Thread 线程切换涉及一个很重要的的结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code>，指向线程栈中的硬件栈。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_hw_stack_frame</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">epc</span><span class="p">;</span><span class="w">        </span><span class="cm">/* epc - epc    - program counter                     */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x1  - ra     - return address for jumps            */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">mstatus</span><span class="p">;</span><span class="w">    </span><span class="cm">/*              - machine status register             */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">gp</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x3  - gp     - global pointer                      */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">tp</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x4  - tp     - thread pointer                      */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t0</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x5  - t0     - temporary register 0                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x6  - t1     - temporary register 1                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x7  - t2     - temporary register 2                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s0_fp</span><span class="p">;</span><span class="w">      </span><span class="cm">/* x8  - s0/fp  - saved register 0 or frame pointer   */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x9  - s1     - saved register 1                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x10 - a0     - return value or function argument 0 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a1</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x11 - a1     - return value or function argument 1 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a2</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x12 - a2     - function argument 2                 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a3</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x13 - a3     - function argument 3                 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a4</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x14 - a4     - function argument 4                 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a5</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x15 - a5     - function argument 5                 */</span>
<span class="cp">#ifndef __riscv_32e</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a6</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x16 - a6     - function argument 6                 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">a7</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x17 - a7     - function argument 7                 */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s2</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x18 - s2     - saved register 2                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s3</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x19 - s3     - saved register 3                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s4</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x20 - s4     - saved register 4                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s5</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x21 - s5     - saved register 5                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s6</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x22 - s6     - saved register 6                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s7</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x23 - s7     - saved register 7                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s8</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x24 - s8     - saved register 8                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s9</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x25 - s9     - saved register 9                    */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s10</span><span class="p">;</span><span class="w">        </span><span class="cm">/* x26 - s10    - saved register 10                   */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">s11</span><span class="p">;</span><span class="w">        </span><span class="cm">/* x27 - s11    - saved register 11                   */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t3</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x28 - t3     - temporary register 3                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t4</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x29 - t4     - temporary register 4                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t5</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x30 - t5     - temporary register 5                */</span>
<span class="w">    </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">t6</span><span class="p">;</span><span class="w">         </span><span class="cm">/* x31 - t6     - temporary register 6                */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f0</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f0  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f1</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f1  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f2</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f2  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f3</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f3  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f4</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f4  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f5</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f5  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f6</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f6  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f7</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f7  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f8</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f8  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f9</span><span class="p">;</span><span class="w">      </span><span class="cm">/* f9  */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f10</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f10 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f11</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f11 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f12</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f12 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f13</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f13 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f14</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f14 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f15</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f15 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f16</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f16 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f17</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f17 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f18</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f18 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f19</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f19 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f20</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f20 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f21</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f21 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f22</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f22 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f23</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f23 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f24</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f24 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f25</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f25 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f26</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f26 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f27</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f27 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f28</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f28 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f29</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f29 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f30</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f30 */</span>
<span class="w">    </span><span class="n">rv_floatreg_t</span><span class="w"> </span><span class="n">f31</span><span class="p">;</span><span class="w">     </span><span class="cm">/* f31 */</span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="n">rt_hw_stack_frame_t</span><span class="p">;</span>
</pre></div>
</div>
<p>该结构体和芯片架构的寄存器密切相关，RISC-V 架构包括 mepc、mstatus、x1、x3~x31、f0~f31。</p>
<p>疑问：</p>
<p>这里发现这个结构体中没有 x0 和 x2，为什么？</p>
<blockquote>
<div><p>x0 为 0，不需要保存；x2 为 sp 指向当前程序运行栈顶地址。</p>
</div></blockquote>
</section>
<section id="id6">
<h3>线程栈数据结构<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p>线程栈结构体部分变量：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_thread</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_object</span><span class="w">            </span><span class="n">parent</span><span class="p">;</span>
<span class="w">    </span><span class="n">rt_list_t</span><span class="w">                   </span><span class="n">tlist</span><span class="p">;</span><span class="w">                  </span><span class="cm">/**&lt; the thread list */</span>

<span class="w">    </span><span class="cm">/* stack point and entry */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                        </span><span class="o">*</span><span class="n">sp</span><span class="p">;</span><span class="w">                    </span><span class="cm">/**&lt; stack point */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                        </span><span class="o">*</span><span class="n">entry</span><span class="p">;</span><span class="w">                 </span><span class="cm">/**&lt; entry */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                        </span><span class="o">*</span><span class="n">parameter</span><span class="p">;</span><span class="w">             </span><span class="cm">/**&lt; parameter */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                        </span><span class="o">*</span><span class="n">stack_addr</span><span class="p">;</span><span class="w">            </span><span class="cm">/**&lt; stack address */</span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w">                 </span><span class="n">stack_size</span><span class="p">;</span><span class="w">             </span><span class="cm">/**&lt; stack size */</span>

<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>宏<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>为了让线程切换相关函数可以兼容 RV32、RV64 多种 RISC-V 指令体系，线程切换相关函数中使用了较多宏，这些宏定义在 cpuport.h 文件中</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Preprocessor Definition */</span>
<span class="cp">#if __riscv_flen == 32</span>
<span class="cp">#define ARCH_RISCV_FPU</span>
<span class="cp">#define ARCH_RISCV_FPU_S</span>
<span class="cp">#endif</span>

<span class="cp">#if __riscv_flen == 64</span>
<span class="cp">#define ARCH_RISCV_FPU</span>
<span class="cp">#define ARCH_RISCV_FPU_D</span>
<span class="cp">#endif</span>

<span class="cm">/* bytes of register width  */</span>
<span class="cp">#ifdef ARCH_CPU_64BIT</span>
<span class="cp">#define STORE                   sd</span>
<span class="cp">#define LOAD                    ld</span>
<span class="cp">#define REGBYTES                8</span>
<span class="cp">#else</span>
<span class="cp">#define STORE                   sw</span>
<span class="cp">#define LOAD                    lw</span>
<span class="cp">#define REGBYTES                4</span>
<span class="cp">#endif</span>

<span class="cm">/* Preprocessor Definition */</span>
<span class="cp">#ifdef ARCH_RISCV_FPU</span>
<span class="cp">#ifdef ARCH_RISCV_FPU_D</span>
<span class="cp">#define FSTORE                  fsd</span>
<span class="cp">#define FLOAD                   fld</span>
<span class="cp">#define FREGBYTES               8</span>
<span class="cp">#define rv_floatreg_t           rt_int64_t</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ARCH_RISCV_FPU_S</span>
<span class="cp">#define FSTORE                  fsw</span>
<span class="cp">#define FLOAD                   flw</span>
<span class="cp">#define FREGBYTES               4</span>
<span class="cp">#define rv_floatreg_t           rt_int32_t</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>在后续介绍的相关任务切换函数中，都使用到了这些宏。</p>
</section>
</section>
<section id="id8">
<h2>5.3、相关指令<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<section id="id9">
<h3>伪指令<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>csrw
用法：<code class="docutils literal notranslate"><span class="pre">csrw</span> <span class="pre">csr,</span> <span class="pre">rs</span></code>
基础指令：<code class="docutils literal notranslate"><span class="pre">csrrw</span> <span class="pre">x0,</span> <span class="pre">csr,</span> <span class="pre">rs</span></code>
含义：写控制寄存器中对应比特</p></li>
<li><p>csrr
用法：<code class="docutils literal notranslate"><span class="pre">csrr</span> <span class="pre">rd，csr</span></code>
基础指令：<code class="docutils literal notranslate"><span class="pre">CSRRS</span> <span class="pre">rd，csr，x0</span></code>
含义：读取控制寄存器
示例：</p></li>
</ul>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="n">csrr</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="w">                </span><span class="c1"># 读取 mstatus 到 t0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>csrs (Control and Status Register Set)
用法：<code class="docutils literal notranslate"><span class="pre">csrs</span> <span class="pre">csr,</span> <span class="pre">rs</span></code>
基础指令：<code class="docutils literal notranslate"><span class="pre">csrrs</span> <span class="pre">x0,</span> <span class="pre">csr,</span> <span class="pre">rs</span></code>
含义：置位控制寄存器中对应比特
示例：</p></li>
</ul>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="n">csrs</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">                </span><span class="c1"># 将 mstatus bit3 置1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>beqz
用法：<code class="docutils literal notranslate"><span class="pre">beqz</span> <span class="pre">rs,</span> <span class="pre">offset</span></code>
基础指令：<code class="docutils literal notranslate"><span class="pre">beq</span> <span class="pre">rs,</span> <span class="pre">x0,</span> <span class="pre">offset</span></code>
含义：寄存器为零分支跳转
示例：</p></li>
<li><p>andi 立即数按位与指令
语法：<code class="docutils literal notranslate"><span class="pre">andi</span> <span class="pre">rd,</span> <span class="pre">rs1,</span> <span class="pre">imm12</span></code>
操作：<code class="docutils literal notranslate"><span class="pre">rd</span> <span class="pre">←</span> <span class="pre">rs1</span> <span class="pre">&amp;</span> <span class="pre">sign_extend(imm12)</span></code></p></li>
<li><p>sw 字存储指令
语法：<code class="docutils literal notranslate"><span class="pre">sw</span> <span class="pre">rs2,</span> <span class="pre">imm12(rs1)</span></code></p></li>
<li><p>lw 有符号扩展字加载指令
语法：<code class="docutils literal notranslate"><span class="pre">lw</span> <span class="pre">rd,</span> <span class="pre">imm12(rs1)</span></code></p></li>
</ul>
</section>
<section id="mret">
<h3>mret<a class="headerlink" href="#mret" title="此标题的永久链接"></a></h3>
<p>当异常程序处理完成后，最终要从异常服务程序中退出，并返回主程序。</p>
<p>RISC-V 中定义了一组退出指令 mret，sret，和 uret，对于机器模式，对应 mret。注意高等级的特权模式可以执行低等级的xret指令，即 M 模式可以执行 mret，sret 和 uret。在机器模式下退出异常时候，软件必须使用 mret。</p>
<p>RISC-V 架构规定，处理器执行完 mret 指令后，硬件行为如下：</p>
<ol class="simple">
<li><p>停止执行当前程序流，转而从 CSR 寄存器 MEPC 定义的 PC 地址开始执行。</p></li>
<li><p>硬件更新 CSR 寄存器机器模式状态寄存器 MSTATUS。MSTATUS 寄存器 MIE 域被更新为当前 MPIE 的值。MPIE 域的值则更新为1。</p></li>
</ol>
</section>
</section>
<section id="id10">
<h2>5.4、线程栈初始化<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p>内核在线程创建和线程初始化中调用 <code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数实现线程栈初始化。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * This function will initialize thread stack</span>
<span class="cm"> *</span>
<span class="cm"> * @param tentry the entry of thread</span>
<span class="cm"> * @param parameter the parameter of entry</span>
<span class="cm"> * @param stack_addr the beginning stack address</span>
<span class="cm"> * @param texit the function will be called when thread exit</span>
<span class="cm"> *</span>
<span class="cm"> * @return stack address</span>
<span class="cm"> */</span>
<span class="n">rt_uint8_t</span><span class="w"> </span><span class="o">*</span><span class="nf">rt_hw_stack_init</span><span class="p">(</span><span class="kt">void</span><span class="w">       </span><span class="o">*</span><span class="n">tentry</span><span class="p">,</span>
<span class="w">                             </span><span class="kt">void</span><span class="w">       </span><span class="o">*</span><span class="n">parameter</span><span class="p">,</span>
<span class="w">                             </span><span class="n">rt_uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">stack_addr</span><span class="p">,</span>
<span class="w">                             </span><span class="kt">void</span><span class="w">       </span><span class="o">*</span><span class="n">texit</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_hw_stack_frame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">;</span>
<span class="w">    </span><span class="n">rt_uint8_t</span><span class="w">         </span><span class="o">*</span><span class="n">stk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">stk</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">);</span>
<span class="w">    </span><span class="n">stk</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rt_uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">RT_ALIGN_DOWN</span><span class="p">((</span><span class="n">rt_ubase_t</span><span class="p">)</span><span class="n">stk</span><span class="p">,</span><span class="w"> </span><span class="n">REGBYTES</span><span class="p">);</span>
<span class="w">    </span><span class="n">stk</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_hw_stack_frame</span><span class="p">);</span>

<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_hw_stack_frame</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stk</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_hw_stack_frame</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">((</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">frame</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeef</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">ra</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">)</span><span class="n">texit</span><span class="p">;</span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">a0</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">)</span><span class="n">parameter</span><span class="p">;</span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">epc</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">)</span><span class="n">tentry</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* force to machine mode(MPP=11) and set MPIE to 1 */</span>
<span class="cp">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">mstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7880</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">mstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1880</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stk</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数主要完成了以下工作：</p>
<ol class="simple">
<li><p>对齐线程栈，对齐长度与当前指令集长度有关，RV32 为 4 字节，RV64 为 8 字节。</p></li>
<li><p>将所有栈数据设置为 0xdeadbeef。</p></li>
<li><p>将传入的 texit、parameter、tentry 分别赋值至线程栈中的 ra、a0、epc。</p></li>
</ol>
<ul class="simple">
<li><p>texit：RT-Thread 内部函数 _thread_exit。</p></li>
<li><p>tentry：用户创建线程的线程函数。</p></li>
<li><p>parameter：传递给线程函数参数。</p></li>
</ul>
<ol class="simple">
<li><p>设置 mstatus，包括 MIE、MPIE、MPP、FS，实现使能 FPU、开启总中断等功能。RT-Thread 一开始就关闭了全局中断，在开始调度器时调用 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_to</span></code> 函数，会将当前线程栈的 mstatus 的值赋值给芯片的 mstatus 寄存器，完成全局中断开启。</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数在 <code class="docutils literal notranslate"><span class="pre">_thread_init</span></code> 函数中被调用，调用形式为：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rt_hw_stack_init</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">,</span>
<span class="w">                                        </span><span class="p">(</span><span class="n">rt_uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">stack_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">stack_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="p">)),</span>
<span class="w">                                        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">_thread_exit</span><span class="p">);</span>
</pre></div>
</div>
<p>通过该函数的传入的参数可以看到，传入的线程栈起始地址 （stack_addr）为 <code class="docutils literal notranslate"><span class="pre">thread-&gt;stack_addr</span> <span class="pre">+</span> <span class="pre">thread-&gt;stack_size</span></code>，该地址为栈顶地址。<code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数将对齐后的线程栈顶地址并减去结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 数据长度作为返回值存储至线程的栈 sp 变量，这个地址也就是线程栈空余空间栈顶地址，后续所有的线程切换都会用到这个 sp 变量。</p>
<p><img alt="stack_addr" src="img/rt-thread/risc-v/port/statc_addr.png" /></p>
</section>
<section id="id11">
<h2>5.5、无来源线程的上下文切换函数<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h2>
<p>该函数在调度器启动第一个线程的时候调用，以及在 signal 中被调用，在 SMP 和非 SMP 的芯片上，该函数对应的 API 不同。</p>
<ul class="simple">
<li><p>非 SMP：<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">rt_hw_context_switch_to(rt_ubase_t</span> <span class="pre">to)</span></code></p></li>
<li><p>SMP：<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">rt_hw_context_switch_to(rt_ubase_t</span> <span class="pre">to,</span> <span class="pre">stuct</span> <span class="pre">rt_thread</span> <span class="pre">*to_thread)</span></code></p></li>
</ul>
<p>不同 API 传入的参数不同，在同一汇编函数中实现，非 SMP 的函数只有1个参数传入给了 a0 寄存器，SMP 的函数同时会将第 2 个参数传给了 a1 寄存器。</p>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_to</span></code> 函数实现如下：</p>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#ifdef RT_USING_SMP</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nf">rt_hw_context_switch_to</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">stuct</span><span class="w"> </span><span class="n">rt_thread</span><span class="w"> </span><span class="o">*</span><span class="n">to_thread</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#else</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nf">rt_hw_context_switch_to</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#endif</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to_thread</span>
<span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">.globl</span><span class="w"> </span><span class="n">rt_hw_context_switch_to</span>
<span class="n">rt_hw_context_switch_to</span><span class="o">:</span>
<span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span>__<span class="n">rt_rvstack</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mscratch</span><span class="p">,</span><span class="n">t0</span>

<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>

<span class="c1">#ifdef RT_USING_SMP</span>
<span class="w">    </span><span class="n">mv</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="n">a1</span>
<span class="w">    </span><span class="n">call</span><span class="w">  </span><span class="n">rt_cpus_lock_status_restore</span>
<span class="c1">#endif</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
<span class="w">    </span><span class="n">j</span><span class="w">    </span><span class="n">rt_hw_context_switch_exit</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_to</span></code> 在调度器启动第一个线程的时候调用，传入的 to 变量即为上文讲到的 <code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数返回保存在线程栈中的 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 指向的地址，这个地址指向的是结构体的第 0 个成员。</p>
<p>在非 SMP 环境下 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_to</span></code> 函数中完成了 4 个工作：</p>
<ol class="simple">
<li><p>将启动文件中设置的栈顶地址 __rt_rvstack 赋值给 mscratch。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">la</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span>__<span class="n">rt_rvstack</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mscratch</span><span class="p">,</span><span class="n">t0</span>
</pre></div>
</div>
<ol class="simple">
<li><p>将目标线程栈 to 指向地址的值赋值给 sp。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="n">LOAD</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
</pre></div>
</div>
<ol class="simple">
<li><p>将 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 结构体中的第 2 个成员内容赋值给了 mstatus。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
</pre></div>
</div>
<ol class="simple">
<li><p>跳转至 rt_hw_context_switch_exit 函数。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">j</span><span class="w">    </span><span class="n">rt_hw_context_switch_exit</span>
</pre></div>
</div>
</section>
<section id="id12">
<h2>5.6、恢复现场<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h2>
<p>指令集架构对应的线程切出与切入是对应的，这里要先重点介绍一下 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_exit</span></code> 这个函数，函数完成主要工作是目标线程现场恢复并切换到该线程。该函数在后续还会被调用。</p>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="n">.global</span><span class="w"> </span><span class="n">rt_hw_context_switch_exit</span>
<span class="n">rt_hw_context_switch_exit</span><span class="o">:</span>
<span class="c1">#ifdef RT_USING_SMP</span>
<span class="c1">#ifdef RT_USING_SIGNALS</span>
<span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>

<span class="w">    </span><span class="n">csrr</span><span class="w">  </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">mhartid</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">switch</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">la</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span>__<span class="n">stack_start__</span>
<span class="w">    </span><span class="n">addi</span><span class="w">  </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="n">li</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span>__<span class="n">STACKSIZE__</span>
<span class="w">    </span><span class="n">mul</span><span class="w">   </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span>
<span class="w">    </span><span class="n">add</span><span class="w">   </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cpuid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>__<span class="n">STACKSIZE__</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>__<span class="n">stack_start__</span><span class="w"> </span><span class="o">*/</span>

<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">rt_signal_check</span>
<span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
<span class="c1">#endif</span>
<span class="c1">#endif</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">resw</span><span class="w"> </span><span class="n">ra</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">csrw</span><span class="w"> </span><span class="n">mepc</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>

<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="c1">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">li</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7800</span>
<span class="c1">#else</span>
<span class="w">    </span><span class="n">li</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1800</span>
<span class="c1">#endif</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">  </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">csrs</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>

<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w">   </span><span class="m">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w">   </span><span class="m">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x7</span><span class="p">,</span><span class="w">   </span><span class="m">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x8</span><span class="p">,</span><span class="w">   </span><span class="m">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x9</span><span class="p">,</span><span class="w">   </span><span class="m">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="c1">#ifndef __riscv_32e</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#else</span>
<span class="w">    </span><span class="n">addi</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#endif</span>

<span class="c1">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f2</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f3</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f5</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f6</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f7</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f8</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f9</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f11</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f12</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f13</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f14</span><span class="p">,</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f15</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f16</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f17</span><span class="p">,</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f18</span><span class="p">,</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f19</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f21</span><span class="p">,</span><span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f22</span><span class="p">,</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f23</span><span class="p">,</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f24</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f25</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f26</span><span class="p">,</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f27</span><span class="p">,</span><span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f28</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f29</span><span class="p">,</span><span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f30</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLOAD</span><span class="w">   </span><span class="n">f31</span><span class="p">,</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FREGBYTES</span>
<span class="c1">#endif</span>

<span class="w">    </span><span class="n">mret</span>
</pre></div>
</div>
<p>这里的 sp 变量依然指向的是参数 to 指向的地址，也就是 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 指向的首地址。</p>
<p>在非 SMP 环境下 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_exit</span></code> 函数依次完成以下工作</p>
<ol class="simple">
<li><p>将目标线程栈结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 0 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">epc</span></code> 值赋值给 mepc。</p></li>
<li><p>恢复 mstatus 寄存器的值</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">li</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7800</span>
<span class="c1">#else</span>
<span class="w">    </span><span class="n">li</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1800</span>
<span class="c1">#endif</span>
<span class="w">    </span><span class="n">csrw</span><span class="w">  </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">csrs</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span>
</pre></div>
</div>
<p>这里的代码看起来有些奇怪，在未开启 FPU 功能宏时，先将 mstatus 对应的 bit11、bit12 置 1，然后再读取目标线程栈结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 2 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">mstatus</span></code>，清除 mstatus 寄存器对应的 bit。</p>
<p>但是在线程初始化函数 <code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 函数中我们也是将线程栈结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 2 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">mstatus</span></code> 设置为 0x1880，是不是这里 csrw 语句有点多余了？这个问题留在后续解答。</p>
<ol class="simple">
<li><p>依次恢复 x4~x31，f0~f31 寄存器的值，并调整当前 sp 地址为栈顶地址。</p></li>
<li><p>调用 <code class="docutils literal notranslate"><span class="pre">mret</span></code> 语句返回，<code class="docutils literal notranslate"><span class="pre">mret</span></code> 从 MEPC 寄存器定义的 PC 地址开始执行。</p></li>
</ol>
</section>
<section id="id13">
<h2>5.7、中断中线程切换<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h2>
<p>从 from 线程切换到 to 线程 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_interrupt(rt_uint32_t</span> <span class="pre">from,</span> <span class="pre">rt_uint32_t</span> <span class="pre">to)</span></code> 该函数用于中断中完成任务切换，SMP 的芯片实现方式不同。</p>
<ul class="simple">
<li><p>无 SMP</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * #ifdef RT_USING_SMP</span>
<span class="cm"> * void rt_hw_context_switch_interrupt(void *context, rt_ubase_t from, rt_ubase_t to, struct rt_thread *to_thread);</span>
<span class="cm"> * #else</span>
<span class="cm"> * void rt_hw_context_switch_interrupt(rt_ubase_t from, rt_ubase_t to, rt_thread_t from_thread, rt_thread_t to_thread);</span>
<span class="cm"> * #endif</span>
<span class="cm"> */</span>
<span class="cp">#ifndef RT_USING_SMP</span>
<span class="n">rt_weak</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">rt_hw_context_switch_interrupt</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">rt_thread_t</span><span class="w"> </span><span class="n">from_thread</span><span class="p">,</span><span class="w"> </span><span class="n">rt_thread_t</span><span class="w"> </span><span class="n">to_thread</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rt_thread_switch_interrupt_flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="n">rt_interrupt_from_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="p">;</span>

<span class="w">    </span><span class="n">rt_interrupt_to_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">;</span>
<span class="w">    </span><span class="n">rt_thread_switch_interrupt_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">rt_trigger_software_interrupt</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* end of RT_USING_SMP */</span>
</pre></div>
</div>
<ul class="simple">
<li><p>SMP</p></li>
</ul>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifdef RT_USING_SMP</span>
<span class="o">/*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nf">rt_hw_context_switch_interrupt</span><span class="p">(</span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">rt_thread</span><span class="w"> </span><span class="o">*</span><span class="n">to_thread</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">context</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">from</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to_thread</span>
<span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">.globl</span><span class="w"> </span><span class="n">rt_hw_context_switch_interrupt</span>
<span class="n">rt_hw_context_switch_interrupt</span><span class="o">:</span>

<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

<span class="w">    </span><span class="n">LOAD</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="w">    </span><span class="n">move</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">rt_cpus_lock_status_restore</span>

<span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="n">rt_hw_context_switch_exit</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p>该函数通过 rt_weak 申请可在需要中断中完成上下文切换的芯片上实现该函数。该函数在内核调度函数 <code class="docutils literal notranslate"><span class="pre">rt_schedule()</span></code> 中被调用，在非 SMP 的芯片上，调用形式为 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_interrupt((rt_ubase_t)&amp;from_thread-&gt;sp,</span> <span class="pre">(rt_ubase_t)&amp;to_thread-&gt;sp,</span> <span class="pre">from_thread,</span> <span class="pre">to_thread)</span></code></p>
<p>中断中线程切换涉及到 3 个变量：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rt_uint32_t</span> <span class="pre">rt_thread_switch_interrupt_flag</span></code>: 表示需要在中断中进行切换的标志。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rt_uint32_t</span> <span class="pre">rt_interrupt_from_thread,</span> <span class="pre">rt_interrupt_to_thread</span></code>: 在线程进行上下文切换时，用于保存 from 和 to 线程。</p></li>
</ul>
<p>在 libcpu/risc-v/common/interrupt_gcc.S 中断处理函数 <code class="docutils literal notranslate"><span class="pre">SW_handler</span></code> 中，通过变量 <code class="docutils literal notranslate"><span class="pre">rt_thread_switch_interrupt_flag</span></code> 判断是否需要找中断中进行线程切换，如果需要就通过 <code class="docutils literal notranslate"><span class="pre">rt_interrupt_from_thread</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rt_interrupt_to_thread</span></code> 变量做上下文切换。相关代码如下：</p>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">Determine</span><span class="w"> </span><span class="n">whether</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="n">scheduling</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">la</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">rt_thread_switch_interrupt_flag</span>
<span class="w">    </span><span class="n">lw</span><span class="w">    </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">beqz</span><span class="w">  </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="n">f</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">rt_thread_switch_interrupt_flag</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">sw</span><span class="w">    </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w">  </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mepc</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">la</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">rt_interrupt_from_thread</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w">  </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>

<span class="w">    </span><span class="n">la</span><span class="w">    </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">rt_interrupt_to_thread</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w">  </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id14">
<h2>5.8、线程和线程间切换<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h2>
<p>从 from 线程切换到 to 线程 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch(rt_uint32_t</span> <span class="pre">from,</span> <span class="pre">rt_uint32_t</span> <span class="pre">to)</span></code> 该函数用于线程和线程之间切换。</p>
<p>该函数在内核调度函数 <code class="docutils literal notranslate"><span class="pre">rt_schedule()</span></code> 中被调用，在非 SMP 的芯片上，调用形式为 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch((rt_ubase_t)&amp;from_thread-&gt;sp,</span> <span class="pre">(rt_ubase_t)&amp;to_thread-&gt;sp);</span></code>。</p>
<p>上面讲到 RT-Thread 适配 RISC-V 架构通用采用线程上下文中实现线程切换而没有使用中断中实现上下文切换，内核使用 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch</span></code> 函数实现线程切换。</p>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch</span></code> 函数实现了保护现场的代码，并调用 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_exit</span></code> 函数实现恢复现场。</p>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch</span></code> 传入的参数 from 和 to 分别对应源线程和目标线程的 sp 变量，对应 a0，a1 寄存器。涉及的工作使用了上面提到过的 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 结构体指向的线程栈中的 sp 变量。</p>
<p>线程切换很重要的一点是搞清楚当前 sp 寄存器地址是处于什么位置。发生线程切换时，sp 寄存器地址在空余栈空间顶，切出线程直接将需要保存的数据写入栈空间实现现场保护，待切入线程 sp 可直接读取到 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 结构体指向的第 0 个成员。</p>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#ifdef RT_USING_SMP</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nf">rt_hw_context_switch</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">rt_thread</span><span class="w"> </span><span class="o">*</span><span class="n">to_thread</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#else</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nf">rt_hw_context_switch</span><span class="p">(</span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">rt_ubase_t</span><span class="w"> </span><span class="n">to</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1">#endif</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">from</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">to_thread</span>
<span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">.globl</span><span class="w"> </span><span class="n">rt_hw_context_switch</span>
<span class="n">rt_hw_context_switch</span><span class="o">:</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">context</span>
<span class="w">     </span><span class="o">*</span><span class="w">     </span><span class="n">x1</span><span class="o">/</span><span class="n">ra</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="w">     </span><span class="o">*</span><span class="w">     </span><span class="n">x1</span><span class="o">/</span><span class="n">ra</span><span class="w">       </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="w">     </span><span class="o">*</span><span class="w">     </span><span class="n">mstatus.mie</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="w">     </span><span class="o">*</span><span class="w">     </span><span class="nf">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="n">i</span><span class="m">-4</span><span class="p">)</span>
<span class="w">     </span><span class="o">*/</span>
<span class="c1">#ifdef ARCH_RISCV_FPU</span>
<span class="w">    </span><span class="n">addi</span><span class="w">    </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">-32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FREGBYTES</span>

<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f2</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f3</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f5</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f6</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f7</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f8</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f9</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f11</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f12</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f13</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f14</span><span class="p">,</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f15</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f16</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f17</span><span class="p">,</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f18</span><span class="p">,</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f19</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f21</span><span class="p">,</span><span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f22</span><span class="p">,</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f23</span><span class="p">,</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f24</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f25</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f26</span><span class="p">,</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f27</span><span class="p">,</span><span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f28</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f29</span><span class="p">,</span><span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f30</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">FSTORE</span><span class="w">  </span><span class="n">f31</span><span class="p">,</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">FREGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="c1">#endif</span>
<span class="c1">#ifndef __riscv_32e</span>
<span class="w">    </span><span class="n">addi</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">-32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#else</span>
<span class="w">    </span><span class="n">addi</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">-16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#endif</span>

<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>

<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="m">8</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">save_mpie</span>
<span class="w">    </span><span class="n">li</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span>
<span class="n">save_mpie</span><span class="o">:</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w">   </span><span class="m">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w">   </span><span class="m">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x7</span><span class="p">,</span><span class="w">   </span><span class="m">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x8</span><span class="p">,</span><span class="w">   </span><span class="m">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x9</span><span class="p">,</span><span class="w">   </span><span class="m">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x11</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x12</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x13</span><span class="p">,</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x14</span><span class="p">,</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x15</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="c1">#ifndef __riscv_32e</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x16</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x17</span><span class="p">,</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x18</span><span class="p">,</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x19</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x21</span><span class="p">,</span><span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x22</span><span class="p">,</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x23</span><span class="p">,</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x24</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x25</span><span class="p">,</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x26</span><span class="p">,</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x27</span><span class="p">,</span><span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x28</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x29</span><span class="p">,</span><span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x30</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x31</span><span class="p">,</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="c1">#endif</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">context</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">epc</span><span class="p">;</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nf">sp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">i</span><span class="m">+2</span><span class="p">)</span>
<span class="w">     </span><span class="o">*/</span>
<span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

<span class="c1">#ifdef RT_USING_SMP</span>
<span class="w">    </span><span class="n">mv</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="n">a2</span>
<span class="w">    </span><span class="n">call</span><span class="w">  </span><span class="n">rt_cpus_lock_status_restore</span>
<span class="c1">#endif /*RT_USING_SMP*/</span>

<span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="n">rt_hw_context_switch_exit</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch</span></code> 函数主要完成了以下工作：
栈是一种先入后出的数据结构，RISC-V 栈空间为向下生长。</p>
<p>当前 sp 寄存器指向的地址是带切出线程栈顶位置，所以需要先采用减法调整 sp 的位置指向 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 0 个成员。</p>
<ol class="simple">
<li><p>先判断 FPU 是否使能，在使能的情况下先通过 <code class="docutils literal notranslate"><span class="pre">addi</span>&#160;&#160;&#160; <span class="pre">sp,</span> <span class="pre">sp,</span> <span class="pre">-32</span> <span class="pre">*</span> <span class="pre">FREGBYTES</span></code> 调整 sp 的位置，并读取 f0~f31 寄存器保存至线程栈。</p></li>
<li><p>通过 <code class="docutils literal notranslate"><span class="pre">__riscv_32e</span></code> 宏判断接下来调整 sp 位置的长度。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifndef __riscv_32e</span>
<span class="w">    </span><span class="n">addi</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">-32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#else</span>
<span class="w">    </span><span class="n">addi</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="m">-16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">REGBYTES</span>
<span class="c1">#endif</span>
</pre></div>
</div>
<ol class="simple">
<li><p>将 sp 寄存器的值调整为 a0 指向地址的值，即传入的待切出线程的空余栈顶地址。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
</pre></div>
</div>
<ol class="simple">
<li><p>将 x1 寄存器的值分别保存至线程栈结构体 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 0 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">epc</span></code> 和第 1 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">ra</span></code>。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">   </span><span class="m">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
</pre></div>
</div>
<p>在线程初始化 <code class="docutils literal notranslate"><span class="pre">rt_hw_stack_init</span></code> 中 x1 被赋值为参数 <code class="docutils literal notranslate"><span class="pre">texit</span></code>，对应 RT-Thread 内部函数 _thread_exit。</p>
<ol class="simple">
<li><p>将 mstatus 寄存器读取至临时变量 a0 后做一些指定的运算，并保存至 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rt_hw_stack_frame</span></code> 中的第 0 个成员 <code class="docutils literal notranslate"><span class="pre">rt_ubase_t</span> <span class="pre">mstatus</span></code></p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">csrr</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">mstatus</span><span class="w">                </span><span class="o">/*</span><span class="w"> </span>读取<span class="w"> </span><span class="n">mstatus</span><span class="w"> </span>寄存器值至<span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">andi</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="w">                  </span><span class="o">/*</span><span class="w"> </span>将<span class="w"> </span><span class="n">a0</span><span class="w"> </span>的值与<span class="w"> </span><span class="mh">0x8</span><span class="w"> </span>做逻辑与运算，<span class="n">mstatus</span><span class="w"> </span>寄存器的<span class="w"> </span><span class="n">bit3</span><span class="w"> </span>为<span class="w"> </span><span class="n">MIE</span>（机器模式全局中断使能位）<span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">beqz</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">save_mpie</span><span class="w">              </span><span class="o">/*</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span>寄存器为<span class="w"> </span><span class="m">0</span><span class="w"> </span>则跳转至<span class="w"> </span><span class="n">save_mpie</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">li</span><span class="w">   </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="w">                   </span><span class="o">/*</span><span class="w">  </span><span class="o">*/</span>
<span class="n">save_mpie</span><span class="o">:</span>
<span class="w">    </span><span class="n">STORE</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w">   </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">REGBYTES</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">    </span><span class="o">/*</span><span class="w"> </span>将<span class="w"> </span><span class="n">a0</span><span class="w"> </span>寄存器的值保存至线程栈对应的值<span class="w"> </span><span class="o">*/</span>
</pre></div>
</div>
<ol class="simple">
<li><p>依次保存 x4~x31，f0~f31 寄存器的值。</p></li>
<li><p>将 sp 寄存器的值调整为 a1 指向地址的值，即传入的待切入线程的栈顶地址。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">LOAD</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
<ol class="simple">
<li><p>跳转至 <code class="docutils literal notranslate"><span class="pre">rt_hw_context_switch_exit</span></code> 函数。</p></li>
</ol>
<div class="highlight-s notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="n">rt_hw_context_switch_exit</span>
</pre></div>
</div>
<p>该函数在上面做过详细分解介绍，实现现场恢复。</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, 燕十三.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>